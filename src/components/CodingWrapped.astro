---
import Coding from "../components/Coding.jsx";

const baseURL = import.meta.env.GUAC_URL;
let authHeader: undefined | { Authorization: string };
const login = async () => {
  const username = import.meta.env.GUAC_USER;
  const password = import.meta.env.GUAC_PASS;
  const loginUrl = `${baseURL}/login`;
  const res = await fetch(loginUrl, {
    method: "POST",
    body: JSON.stringify({
      username,
      password,
    }),
  });
  if (res?.status !== 200) {
    console.error(res);
    return;
  }
  const { token } = await res.json();
  return { Authorization: `Bearer ${token}` };
};

const fetchGuac = async (start: string, end: string) => {
  if (!authHeader) {
    authHeader = await login();
  }
  const res = await fetch(`${baseURL}/data?start=${start}&end=${end}`, {
    headers: authHeader,
  });
  if (res?.status !== 200) {
    throw new Error("Failed to get data from guac api");
  }
  const data = await res.json();
  return data?.languageStats;
};

const fetchWithMonths = async (months: number) => {
  const today = new Date().toISOString().split("T")[0];
  let before = new Date();
  before.setMonth(before.getMonth() - months);
  const beforeStr = before.toISOString().split("T")[0];
  const languageData = await fetchGuac(beforeStr, today);
  return languageData?.percentages;
};

const dataSet = [
  {
    months: 3,
    data: await fetchWithMonths(3),
  },
  // {
  //   months: 6,
  //   data: await fetchWithMonths(6),
  // },
  // {
  //   months: 12,
  //   data: await fetchWithMonths(12),
  // },
];
---

<Coding client:visible dataSet={dataSet} topN={7} />
